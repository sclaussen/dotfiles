#!/bin/bash
# xdg-open wrapper for devcontainers
# This intercepts browser open requests and forwards them to the host

URL="$1"

# Log for debugging
echo "[xdg-open wrapper] Opening: $URL" >&2

# If it's a URL, try to forward to host
if [[ "$URL" =~ ^https?:// ]]; then
    # Try different methods to open on host
    
    # Method 1: Use nc to send to our server (if running)
    if echo "OPEN:$URL" | nc -w 1 host.docker.internal 9559 2>/dev/null | grep -q "OK"; then
        echo "[xdg-open wrapper] Successfully sent to browser server" >&2
        exit 0
    fi
    
    # Method 2: Try SSH to host (macOS specific)
    if command -v ssh >/dev/null 2>&1; then
        if ssh -o ConnectTimeout=1 -o StrictHostKeyChecking=no docker.for.mac.localhost "open '$URL'" 2>/dev/null; then
            echo "[xdg-open wrapper] Opened via SSH" >&2
            exit 0
        fi
    fi
    
    # Method 3: Just display the URL clearly
    echo ""
    echo "========================================"
    echo "Please open this URL in your browser:"
    echo "$URL"
    echo "========================================"
    echo ""
else
    # Not a URL, try regular xdg-open if it exists
    if [ -f /usr/bin/xdg-open ]; then
        /usr/bin/xdg-open "$@"
    else
        echo "[xdg-open wrapper] Cannot open: $URL" >&2
    fi
fi